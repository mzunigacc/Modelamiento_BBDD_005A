ALTER SESSION SET CURRENT_SCHEMA = PRY2204_S9;


-- el drop a tablas y al seq por separado
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ASIGNACION_TURNO CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE ORDEN_MANTENCION CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE EMPLEADO CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE TURNO CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE MAQUINA CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE TIPO_MAQUINA CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE PLANTA CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE COMUNA CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE REGION CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE AFP CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE SISTEMA_SALUD CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

BEGIN
    EXECUTE IMMEDIATE 'DROP SEQUENCE SEQ_REGION';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/

CREATE SEQUENCE SEQ_REGION START WITH 21 INCREMENT BY 1;

CREATE TABLE REGION (
    id_region NUMBER PRIMARY KEY,
    nombre VARCHAR2(50) UNIQUE NOT NULL
);

CREATE TABLE COMUNA (
    id_comuna NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 1050 INCREMENT BY 5),
    nombre VARCHAR2(50) NOT NULL,
    id_region NUMBER NOT NULL,
    CONSTRAINT PK_COMUNA PRIMARY KEY (id_comuna),
    CONSTRAINT FK_COMUNA_REGION FOREIGN KEY (id_region) REFERENCES REGION(id_region)
);

CREATE TABLE PLANTA (
    id_planta NUMBER PRIMARY KEY,
    nombre VARCHAR2(100) NOT NULL,
    direccion VARCHAR2(100) NOT NULL,
    id_comuna NUMBER NOT NULL,
    CONSTRAINT FK_PLANTA_COMUNA FOREIGN KEY (id_comuna) REFERENCES COMUNA(id_comuna)
);

CREATE TABLE AFP (
    id_afp NUMBER PRIMARY KEY,
    nombre VARCHAR2(50) UNIQUE NOT NULL
);

CREATE TABLE SISTEMA_SALUD (
    id_salud NUMBER PRIMARY KEY,
    nombre VARCHAR2(50) UNIQUE NOT NULL
);

CREATE TABLE TIPO_MAQUINA (
    id_tipo NUMBER PRIMARY KEY,
    nombre VARCHAR2(50) UNIQUE NOT NULL
);

CREATE TABLE MAQUINA (
    id_maquina NUMBER GENERATED BY DEFAULT AS IDENTITY,
    numero VARCHAR2(20) NOT NULL,
    nombre VARCHAR2(100) NOT NULL,
    activo CHAR(1) DEFAULT 'S' CHECK (activo IN ('S','N')),
    id_planta NUMBER NOT NULL,
    id_tipo NUMBER NOT NULL,
    CONSTRAINT PK_MAQUINA PRIMARY KEY (id_maquina),
    CONSTRAINT FK_MAQUINA_PLANTA FOREIGN KEY (id_planta) REFERENCES PLANTA(id_planta),
    CONSTRAINT FK_MAQUINA_TIPO FOREIGN KEY (id_tipo) REFERENCES TIPO_MAQUINA(id_tipo)
);

CREATE TABLE TURNO (
    id_turno NUMBER PRIMARY KEY,
    nombre VARCHAR2(50) UNIQUE NOT NULL,
    hora_inicio VARCHAR2(5) NOT NULL,
    hora_fin VARCHAR2(5) NOT NULL
);

CREATE TABLE EMPLEADO (
    id_empleado NUMBER PRIMARY KEY,
    rut VARCHAR2(12) NOT NULL,
    nombres VARCHAR2(100) NOT NULL,
    apellidos VARCHAR2(100) NOT NULL,
    fecha_contrato DATE NOT NULL,
    sueldo_base NUMBER(10,2) NOT NULL,
    activo CHAR(1) DEFAULT 'S' CHECK (activo IN ('S','N')) NOT NULL,
    id_planta NUMBER NOT NULL,
    id_afp NUMBER NOT NULL,
    id_salud NUMBER NOT NULL,
    id_jefe NUMBER NULL,
    area_responsabilidad VARCHAR2(100) NOT NULL,
    max_operarios NUMBER NOT NULL,
    categoria VARCHAR2(50),
    certificacion VARCHAR2(100) NULL,
    horas_turno NUMBER DEFAULT 8,
    especialidad VARCHAR2(50),
    nivel_certificacion VARCHAR2(50),
    tiempo_respuesta NUMBER,
    CONSTRAINT FK_EMP_PLANTA FOREIGN KEY (id_planta) REFERENCES PLANTA(id_planta),
    CONSTRAINT FK_EMP_AFP FOREIGN KEY (id_afp) REFERENCES AFP(id_afp),
    CONSTRAINT FK_EMP_SALUD FOREIGN KEY (id_salud) REFERENCES SISTEMA_SALUD(id_salud),
    CONSTRAINT FK_EMP_JEFE FOREIGN KEY (id_jefe) REFERENCES EMPLEADO(id_empleado)
);

CREATE TABLE ORDEN_MANTENCION (
    id_orden NUMBER PRIMARY KEY,
    id_maquina NUMBER NOT NULL,
    id_tecnico NUMBER NOT NULL,
    fecha_programada DATE NOT NULL,
    fecha_ejecucion DATE NOT NULL,
    descripcion VARCHAR2(200),
    CONSTRAINT FK_ORD_MAQ FOREIGN KEY (id_maquina) REFERENCES MAQUINA(id_maquina),
    CONSTRAINT FK_ORD_TEC FOREIGN KEY (id_tecnico) REFERENCES EMPLEADO(id_empleado),
    CONSTRAINT CK_FECHAS CHECK (fecha_ejecucion >= fecha_programada)
);

CREATE TABLE ASIGNACION_TURNO (
    id_asignacion NUMBER PRIMARY KEY,
    id_empleado NUMBER NOT NULL,
    id_turno NUMBER NOT NULL,
    id_maquina NUMBER NOT NULL,
    fecha DATE NOT NULL,
    rol_turno VARCHAR2(50) NOT NULL,
    CONSTRAINT UNQ_ASIG_EMP_FECHA UNIQUE (id_empleado, fecha),
    CONSTRAINT FK_ASIG_EMP FOREIGN KEY (id_empleado) REFERENCES EMPLEADO(id_empleado),
    CONSTRAINT FK_ASIG_TURNO FOREIGN KEY (id_turno) REFERENCES TURNO(id_turno),
    CONSTRAINT FK_ASIG_MAQ FOREIGN KEY (id_maquina) REFERENCES MAQUINA(id_maquina)
);



-- Insert a las tablas para tener datos que recuperar

INSERT INTO REGION (id_region, nombre) VALUES (SEQ_REGION.NEXTVAL, 'Region Metropolitana');
INSERT INTO REGION (id_region, nombre) VALUES (SEQ_REGION.NEXTVAL, 'Valparaiso');
INSERT INTO REGION (id_region, nombre) VALUES (SEQ_REGION.NEXTVAL, 'Biobio');

INSERT INTO COMUNA (nombre, id_region) VALUES ('Santiago', 21);
INSERT INTO COMUNA (nombre, id_region) VALUES ('Maipu', 21);
INSERT INTO COMUNA (nombre, id_region) VALUES ('Valparaiso', 22);
INSERT INTO COMUNA (nombre, id_region) VALUES ('Vina del Mar', 22);
INSERT INTO COMUNA (nombre, id_region) VALUES ('Concepcion', 23);

INSERT INTO PLANTA (id_planta, nombre, direccion, id_comuna) VALUES (1, 'Planta Central', 'Av. Principal 100', 1050);
INSERT INTO PLANTA (id_planta, nombre, direccion, id_comuna) VALUES (2, 'Planta Norte', 'Calle Industrial 200', 1060);

INSERT INTO AFP (id_afp, nombre) VALUES (1, 'AFP Habitat');
INSERT INTO AFP (id_afp, nombre) VALUES (2, 'AFP Capital');
INSERT INTO AFP (id_afp, nombre) VALUES (3, 'AFP Provida');
INSERT INTO AFP (id_afp, nombre) VALUES (4, 'AFP Modelo');

INSERT INTO SISTEMA_SALUD (id_salud, nombre) VALUES (1, 'Fonasa');
INSERT INTO SISTEMA_SALUD (id_salud, nombre) VALUES (2, 'Isapre');
INSERT INTO SISTEMA_SALUD (id_salud, nombre) VALUES (3, 'Otro Seguro');

INSERT INTO TIPO_MAQUINA (id_tipo, nombre) VALUES (1, 'Linea IS');
INSERT INTO TIPO_MAQUINA (id_tipo, nombre) VALUES (2, 'Horno');
INSERT INTO TIPO_MAQUINA (id_tipo, nombre) VALUES (3, 'Empaque');

INSERT INTO TURNO (id_turno, nombre, hora_inicio, hora_fin) VALUES (1, 'Manana', '06:00', '14:00');
INSERT INTO TURNO (id_turno, nombre, hora_inicio, hora_fin) VALUES (2, 'Tarde', '14:00', '22:00');
INSERT INTO TURNO (id_turno, nombre, hora_inicio, hora_fin) VALUES (3, 'Noche', '22:00', '06:00');

INSERT INTO MAQUINA (id_maquina, numero, nombre, activo, id_planta, id_tipo) VALUES (1, 'M-100', 'Linea IS 100', 'S', 1, 1);
INSERT INTO MAQUINA (id_maquina, numero, nombre, activo, id_planta, id_tipo) VALUES (2, 'H-200', 'Horno 200', 'S', 2, 2);


INSERT INTO EMPLEADO (
    id_empleado, rut, nombres, apellidos, fecha_contrato, sueldo_base,
    id_planta, id_afp, id_salud, id_jefe, area_responsabilidad, max_operarios
) VALUES (
    1, '11111111-1', 'Juan', 'Perez', DATE '2024-01-10', 900000,
    1, 1, 2, NULL, 'Formado', 10
);


INSERT INTO EMPLEADO (
    id_empleado, rut, nombres, apellidos, fecha_contrato, sueldo_base,
    id_planta, id_afp, id_salud, id_jefe, area_responsabilidad, max_operarios,
    categoria, certificacion, horas_turno
) VALUES (
    2, '22222222-2', 'Maria', 'Gonzalez', DATE '2024-02-01', 650000,
    1, 2, 1, 1, 'Inspeccion', 6,
    'inspeccion', 'cert_inspeccion_a', 8
);


INSERT INTO EMPLEADO (
    id_empleado, rut, nombres, apellidos, fecha_contrato, sueldo_base,
    id_planta, id_afp, id_salud, id_jefe, area_responsabilidad, max_operarios,
    especialidad, nivel_certificacion, tiempo_respuesta
) VALUES (
    3, '33333333-3', 'Pedro', 'Ramirez', DATE '2024-03-01', 800000,
    2, 3, 1, 1, 'Mantenimiento', 8,
    'mecanica', 'N2', 4
);

INSERT INTO ASIGNACION_TURNO (id_asignacion, id_empleado, id_turno, id_maquina, fecha, rol_turno)
SELECT 1000 + LEVEL, 2, CASE MOD(LEVEL-1,3) WHEN 0 THEN 1 WHEN 1 THEN 2 ELSE 3 END, 1, DATE '2025-02-01' + (LEVEL-1), 'Operario'
FROM dual
CONNECT BY LEVEL <= 30;

INSERT INTO ASIGNACION_TURNO (id_asignacion, id_empleado, id_turno, id_maquina, fecha, rol_turno)
SELECT 2000 + LEVEL, 3, 3, 2, DATE '2025-02-01' + (LEVEL-1), 'Tecnico'
FROM dual
CONNECT BY LEVEL <= 30;


-- consultas especificas
-- INFORME 1: Turnos con hora inicio posterior a 20:00
SELECT 
    a.id_asignacion AS numero_turno,
    t.nombre AS nombre_turno,
    t.hora_inicio,
    t.hora_fin,
    a.fecha,
    a.id_maquina,
    e.nombres || ' ' || e.apellidos AS nombre_empleado
FROM ASIGNACION_TURNO a
LEFT JOIN TURNO t ON t.id_turno = a.id_turno
LEFT JOIN EMPLEADO e ON e.id_empleado = a.id_empleado
WHERE t.hora_inicio > '20:00'
ORDER BY t.hora_inicio DESC;

-- INFORME 2: Turnos diurnos (inicio entre 06:00 y 14:59)
SELECT 
    a.id_asignacion AS numero_turno,
    t.nombre AS nombre_turno,
    t.hora_inicio,
    t.hora_fin,
    a.fecha,
    a.id_maquina,
    e.nombres || ' ' || e.apellidos AS nombre_empleado
FROM ASIGNACION_TURNO a
LEFT JOIN TURNO t ON t.id_turno = a.id_turno
LEFT JOIN EMPLEADO e ON e.id_empleado = a.id_empleado
WHERE t.hora_inicio BETWEEN '06:00' AND '14:59'
ORDER BY t.hora_inicio ASC;

